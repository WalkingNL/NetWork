#### 什么是SYN flood 攻击
SYN flood攻击也称半连接攻击(half-open attack)，是一种[分布式拒绝服务攻击(DDoS attack)](https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack/)。其目标是通过消耗所有可用的服务器资源，使得服务器无法响应合法的连接请求。通过重复的发送初始的连接请求包(SYN packets)，攻击者侵占了目标服务器所有可用的端口，致使其响应合法请求过慢甚至无法响应。

#### SYN flood 攻击的工作原理
**SYN flood 攻击利用了TCP请求建立连接时，握手的过程。正常情况下，建立一个TCP连接需三步，而且这三步完全不同**。如下：
1. 首先，客户端请求与服务端建立连接，会发送一个SYN包到对端(指服务段)。
2. 服务端收到这个SYN包后，发送一个SYN/ACK进行响应。
3. 最后，客户端一旦受到服务端响应的包(SYN/ACK)，会返回一个ACK包进行确认。这样的一个过程完成之后，就可以在此连接下，进行发送和接受数据。
![](https://www.cloudflare.com/img/learning/ddos/syn-flood-ddos-attack/syn-flood-attack-ddos-attack-diagram-1.png)

要达到拒绝正常服务连接请求的目的，攻击者的策略是，如上面1，2所述，发送一个初始的SYN请求包，并已被服务端接收并反馈SYN/ACK进行响应，然后服务端等待客户端的确认包，上述第3。这个过程具体可描述为以下：
1. 攻击者通常使用伪造的IP地址([spoofed](https://www.cloudflare.com/learning/ddos/glossary/ip-spoofing/) IP addresses)发送巨量的SYN包给目标服务器。
2. 接着，服务器收到这些连接请求后，会去全部进行响应，且分配就绪的端口等待客户端的确认包。
3. 就在服务段等待客户端的确认包的时候，攻击者继续发送更多的SYN包。每到一个新的SYN包，服务段就像1，2所述的那样，建立临时的连接，并等待客户端最后的确认包。而这种临时的连接会维持一个确定长的时间，并最终因为没有受到确认包，而放弃连接。但是这个确定长的时间，还会有新的SYN进来，最终导致服务段所有的端口都被占用，建立TCP连接的功能也就瘫痪。
![](https://www.cloudflare.com/img/learning/ddos/syn-flood-ddos-attack/syn-flood-attack-ddos-attack-diagram-2.png)
在网络中，当服务器正在打开一个连接时，原来试图与其建立连接的对端(即客户端)却没有，把这类连接叫做半连接(half-open)。此类DDoS攻击中，服务器持续的打开连接并等待端口再次变得可用之前，此连接超时。这种攻击就是半连接攻击(half-open attack)。

##### 产生SYN flood有三种不同的方式
1. 直接攻击：SYN flood被称为直接攻击，其特点是攻击者不掩藏IP地址。由于攻击者使用具有真实IP地址的单一设备创建攻击，所以攻击者很容易被发现。为了能够与目标机器建立这种半连接，黑客会刻意的拒绝响应服务端的SYN/ACK包。通常达到次目的，可以通过修改防火墙规则阻止自己的机器对外发送除SYN包以外的其他包，也可以通过过滤掉即将到达攻击者机器的SYN/ACK包。在实际中，这种方法很少被用到(如果有的话)，因为其很容被发现并且规避掉-仅仅通过阻止攻击者的IP地址就可以。但是如果攻击者使用类似Mirai botnet这样的僵尸网络([botnet](https://www.cloudflare.com/learning/ddos/what-is-a-ddos-botnet/))中的计算机，他们就不会关心所谓是不是真实的IP地址这种东西了。（注：僵尸网络意指一组已经被病毒感染的计算机，黑客利用这样的计算机，发起SYN flood攻击时，不用关心IP地址是否被掩藏）。
2. 欺骗性攻击。攻击者为了避免自己的机器易被发现，他们会在发送的每一个SYN包上，修改IP地址，达到掩盖自己真实IP的目的。虽然包被修改了，但是这些包可能会被追溯到源头，虽然在操作上比较困难，但并非不可能，尤其是网络服务供应商(IPSs)们愿意提供帮助的情况下。
3. 分布式攻击。如果使用僵尸网络(botnet)进行攻击的话，被追踪到源头的可能性是非常低的。对更高级别的混淆而言，攻击者可能拥有每一个分布式设备，而且修改掉发送的数据包的IP地址。

通过使用SYN flood攻击，黑客可以花费更少的流量，在服务端建立DDoS攻击。相比于容量耗尽攻击(volumetric attacks), 一种可以使目标机器周围的网络拥塞的攻击方式，SYN攻击只需要达到耗尽目标机器的OS中syns queue(用户保存半连接的请求。这个队列的大小，与backlog参数有关)。如果攻击者能够决定backlog的大小，以及每一个连接被丢弃前的时长，攻击者便可以设定精确的参数来攻击目标系统，从而减少总体的流量损耗。

##### 如何降低SYN flood的攻击
SYN flood攻击的弱点早已被探明并且降低受其攻击的途径也有若干种一直被使用。分别有以下：
##### 提升 Backlog Queue的大小
目标设备上的每一个OS都有一个其所允许的能够建立的半连接数量。意味着，可以通过提升OS所允许建立的半连接数量的方式，建立更多的半连接。为了能够成功的增大backlog的最大值，就需要OS预留额外的内存资源以应多全部新的请求。但是，如果OS没有足够的内存处理因为增大了backlog而到来的所有新的连接请求，那OS的性能会受到重创，但或许这总比受到DDoS攻击要好。
##### 回收保持半连接状态最久的TCP连接
另一种应对SYN flood 攻击的缓解策略是当backlog queue已经满了的时候，新的请求进来，就收回处于最早状态的半连接，以释放端口。这种策略有一个前提是，必须要保证正常的连接建立所需要的时间少于恶意的SYN包填满backlog队列的时间。当攻击包的数量提升到很大，这种防御的策略仍然会失败，或者是backlog太小的话。
##### 通过SYN cookies
这个策略涉及服务器创建cookie。为了避免backlog队列被填满时，连接被丢弃的风险，服务器采用的策略是使用SYN-ACK响应每一个连接请求，之后再从backlog队列中删除SYN请求，使对应端口处于就绪状态并且准备分配给新的连接。如果这个连接请求时正常的，最后的ACK包会被发送至服务段，服务器会接着重新建立(有一定的限制)SYN backlog队列的。虽然这种基于缓解的策略会导致TCP连接丢失一些信息，但总比合法用户因为攻击而拒绝服务要好。
